<?xml version="1.0" encoding="utf-8"?>
<Project>
  <UsingTask TaskName="ReferenceTrimmerTask" AssemblyFile="$(ReferenceTrimmerTaskAssembly)" />

  <PropertyGroup>
    <ReferenceTrimmerGetUsedAssemblyReferencesFile>$([System.IO.Path]::GetFullPath('$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(IntermediateOutputPath)', '_ReferenceTrimmer_GetUsedAssemblyReferences.txt'))'))</ReferenceTrimmerGetUsedAssemblyReferencesFile>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);DeleteReferenceTrimmerGetUsedAssemblyReferencesFile</CoreCompileDependsOn>
  </PropertyGroup>

  <ItemGroup Condition="'$(EnableReferenceTrimmer)' != 'false'">
    <!-- https://github.com/dotnet/roslyn/blob/main/docs/analyzers/Using%20Additional%20Files.md#in-a-project-file -->
    <AdditionalFiles Include="$(ReferenceTrimmerGetUsedAssemblyReferencesFile)" />
    <FileWrites Include="$(ReferenceTrimmerGetUsedAssemblyReferencesFile)" />
  </ItemGroup>

  <Target Name="DeleteReferenceTrimmerGetUsedAssemblyReferencesFile" Condition="'$(EnableReferenceTrimmer)' != 'false'" BeforeTargets="BeforeBuild" >
    <Delete Files="$(ReferenceTrimmerGetUsedAssemblyReferencesFile)" Condition="Exists('$(ReferenceTrimmerGetUsedAssemblyReferencesFile)')" />
  </Target>

  <Target Name="VerifyReferences"
          Condition="'$(EnableReferenceTrimmer)' != 'false'"
          AfterTargets="AfterBuild"
          DependsOnTargets="ResolveProjectReferences">
    <ItemGroup>
      <_ReferenceTrimmerProjectReferences Include="@(ReferencePath)" Condition="'%(ReferencePath.ReferenceSourceTarget)' == 'ProjectReference'" />
    </ItemGroup>

    <ReadLinesFromFile File="$(ReferenceTrimmerGetUsedAssemblyReferencesFile)">
      <Output TaskParameter="Lines" ItemName="UsedReference" />
    </ReadLinesFromFile>
    <Warning Text="Skipping ReferenceTrimmerTask due to empty file $(ReferenceTrimmerGetUsedAssemblyReferencesFile)" Condition=" '@(UsedReference)' == '' "/>

    <ReferenceTrimmerTask
      Condition=" '@(UsedReference)' != '' "
      MSBuildProjectFile="$(MSBuildProjectFile)"
      UsedReferences="@(UsedReference)"
      References="@(Reference)"
      ProjectReferences="@(_ReferenceTrimmerProjectReferences)"
      PackageReferences="@(PackageReference)"
      ProjectAssetsFile="$(ProjectAssetsFile)"
      TargetFramework="$(TargetFramework)"
      RuntimeIdentifier="$(RuntimeIdentifier)"
      NuGetRestoreTargets="$(NuGetRestoreTargets)"
      TargetFrameworkDirectories="$(TargetFrameworkDirectory)" />
  </Target>
</Project>